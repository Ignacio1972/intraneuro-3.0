<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema Modular - IntraNeuro</title>

    <!-- CSS necesario -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/pacientes.css">

    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .test-actions {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        .test-btn {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: #007bff;
            color: white;
        }
        .test-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .test-info {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 20px 0;
            border-radius: 4px;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üî∑ Test Sistema Modular v3.0</h1>
            <p>Ambiente de prueba para la arquitectura modular de componentes</p>
        </div>

        <div class="test-info">
            <h3>üìã Estado del Sistema</h3>
            <ul>
                <li>‚úÖ BaseComponent cargado</li>
                <li>‚úÖ ModalOrchestrator cargado</li>
                <li>‚úÖ DischargeComponent cargado (Fase 2.1)</li>
                <li>‚úÖ NotesComponent cargado (Fase 2.2)</li>
                <li>‚ö†Ô∏è Otros componentes: Pendientes (Fase 2.3+)</li>
            </ul>
        </div>

        <div class="test-info">
            <h3>üéØ Pacientes de Prueba</h3>
            <p>Usa estos IDs para probar:</p>
            <ul id="patient-list">
                <li>Cargando pacientes...</li>
            </ul>
        </div>

        <div class="test-actions">
            <button class="test-btn" onclick="testOpenModal(1)">
                üî∑ Probar Modal Modular (ID: 1)
            </button>
            <button class="test-btn" onclick="testOpenModal(90)">
                üî∑ Probar Modal Modular (ID: 90)
            </button>
            <button class="test-btn" onclick="testOpenModal(210)">
                üî∑ Probar Modal Modular (ID: 210)
            </button>
            <button class="test-btn" onclick="showConsoleInfo()">
                üìä Ver Info del Sistema
            </button>
        </div>

        <div class="console-output" id="console-output">
            <div>üî∑ Sistema Modular - Consola de Debug</div>
            <div>Presiona los botones arriba para probar...</div>
        </div>
    </div>

    <!-- Modal de Pacientes -->
    <div id="patientModal" class="modal">
        <div class="modal-content patient-modal-content">
            <!-- El contenido ser√° generado din√°micamente por el orquestador -->
        </div>
    </div>

    <!-- Scripts SOLO del sistema modular -->
    <script>
        // Mock data para testing (datos simplificados)
        window.patients = [
            {
                id: 1,
                name: "Juan P√©rez",
                age: 45,
                rut: "12.345.678-9",
                bed: "101",
                admissionDate: "2025-11-01",
                dischargeDate: null,
                scheduledDischarge: false,
                observations: "‚Ä¢ Paciente estable\n‚Ä¢ Signos vitales normales\n‚Ä¢ Continuar con medicaci√≥n actual"
            },
            {
                id: 90,
                name: "Mar√≠a Gonz√°lez",
                age: 62,
                rut: "23.456.789-0",
                bed: "205",
                admissionDate: "2025-10-15",
                dischargeDate: null,
                scheduledDischarge: true,
                observations: "‚Ä¢ Paciente con alta programada\n‚Ä¢ Evoluci√≥n favorable\n‚Ä¢ Pendiente √∫ltimos ex√°menes"
            },
            {
                id: 210,
                name: "Pedro Silva (Egresado)",
                age: 38,
                rut: "34.567.890-1",
                bed: "103",
                admissionDate: "2025-09-10",
                dischargeDate: "2025-10-20",
                dischargeDetails: "Alta m√©dica - Evoluci√≥n favorable",
                deceased: false,
                dischargedBy: "Dr. L√≥pez"
            }
        ];

        // Funci√≥n para abrir/cerrar modal (simplificada)
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                logToConsole(`‚úÖ Modal ${modalId} abierto`);
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                logToConsole(`‚úÖ Modal ${modalId} cerrado`);
            }
        }

        // Toast simple
        window.showToast = function(message, type = 'success') {
            logToConsole(`üì¢ Toast [${type}]: ${message}`);
            alert(`[${type.toUpperCase()}] ${message}`);
        };

        // Logging
        function logToConsole(message) {
            const output = document.getElementById('console-output');
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `\n[${time}] ${message}`;
            output.scrollTop = output.scrollHeight;
        }

        // Test function
        function testOpenModal(patientId) {
            logToConsole(`\nüî∑ === INICIANDO TEST MODAL MODULAR (ID: ${patientId}) ===`);

            const patient = window.patients.find(p => p.id === patientId);
            if (!patient) {
                logToConsole(`‚ùå Paciente ${patientId} no encontrado`);
                return;
            }

            logToConsole(`‚úÖ Paciente encontrado: ${patient.name}`);
            logToConsole(`üìä Estado: ${patient.dischargeDate ? 'Egresado' : 'Activo'}`);

            // Llamar a la funci√≥n modular
            if (typeof window.openPatientModalModular === 'function') {
                window.openPatientModalModular(patientId);
            } else {
                logToConsole('‚ùå openPatientModalModular no est√° disponible');
            }
        }

        function showConsoleInfo() {
            logToConsole('\nüìä === INFORMACI√ìN DEL SISTEMA ===');
            logToConsole(`‚úÖ BaseComponent: ${typeof ModalComponent !== 'undefined' ? 'Cargado' : 'NO cargado'}`);
            logToConsole(`‚úÖ ModalOrchestrator: ${typeof PatientModalOrchestrator !== 'undefined' ? 'Cargado' : 'NO cargado'}`);
            logToConsole(`‚úÖ DischargeComponent: ${typeof DischargeComponent !== 'undefined' ? 'Cargado' : 'NO cargado'}`);
            logToConsole(`‚úÖ NotesComponent: ${typeof NotesComponent !== 'undefined' ? 'Cargado' : 'NO cargado'}`);
            logToConsole(`‚úÖ patientModalOrchestrator: ${typeof window.patientModalOrchestrator !== 'undefined' ? 'Disponible' : 'NO disponible'}`);
            logToConsole(`‚úÖ openPatientModalModular: ${typeof window.openPatientModalModular === 'function' ? 'Disponible' : 'NO disponible'}`);
            logToConsole(`üìã Total pacientes mock: ${window.patients.length}`);
        }

        // Mock API
        const PacientesAPI = {
            async toggleScheduledDischargeAPI(patientId, value) {
                logToConsole(`üåê API: Toggle alta programada - ID: ${patientId}, Valor: ${value}`);
                // Simular delay
                await new Promise(resolve => setTimeout(resolve, 300));

                // Actualizar mock data
                const patient = window.patients.find(p => p.id === patientId);
                if (patient) {
                    patient.scheduledDischarge = value;
                }

                return { success: true };
            },

            async processDischargeAPI(patientId, data) {
                logToConsole(`üåê API: Procesar egreso - ID: ${patientId}`);
                logToConsole(`üìù Datos: ${JSON.stringify(data)}`);

                // Simular delay
                await new Promise(resolve => setTimeout(resolve, 500));

                // Actualizar mock data
                const patient = window.patients.find(p => p.id === patientId);
                if (patient) {
                    patient.dischargeDate = data.date;
                    patient.dischargeDetails = data.details;
                    patient.deceased = data.deceased;
                    patient.dischargedBy = data.dischargedBy;
                }

                return { success: true };
            }
        };

        // Mock apiRequest para NotesComponent
        window.apiRequest = async function(url, options = {}) {
            const patientIdMatch = url.match(/\/patients\/(\d+)/);
            const patientId = patientIdMatch ? parseInt(patientIdMatch[1]) : null;

            logToConsole(`üåê API Request: ${options.method || 'GET'} ${url}`);

            // GET /patients/:id/admission/observations
            if (url.includes('/observations') && (!options.method || options.method === 'GET')) {
                const patient = window.patients.find(p => p.id === patientId);
                if (patient && patient.observations) {
                    return [{
                        id: 1,
                        admission_id: 1,
                        observation: patient.observations,
                        created_by: 'Dr. Test',
                        created_at: new Date().toISOString()
                    }];
                }
                return [];
            }

            // POST /patients/:id/admission/observations
            if (url.includes('/observations') && options.method === 'POST') {
                await new Promise(resolve => setTimeout(resolve, 300));

                const body = JSON.parse(options.body);
                const patient = window.patients.find(p => p.id === patientId);
                if (patient) {
                    patient.observations = body.observation;
                }

                logToConsole(`‚úÖ Observaci√≥n guardada: ${body.observation.substring(0, 50)}...`);
                return { success: true };
            }

            // GET /patients/:id/admission/tasks (para TaskManager legacy)
            if (url.includes('/tasks') && (!options.method || options.method === 'GET')) {
                return [];
            }

            return { success: true };
        };

        // Cargar lista de pacientes al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            const list = document.getElementById('patient-list');
            list.innerHTML = window.patients.map(p =>
                `<li><strong>ID ${p.id}:</strong> ${p.name} ${p.dischargeDate ? '(Egresado)' : '(Activo)'}</li>`
            ).join('');

            logToConsole('‚úÖ Sistema de prueba inicializado');
            logToConsole('üìã 3 pacientes mock cargados');
        });

        // Override console.log para capturar logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && typeof args[0] === 'string' && args[0].includes('[')) {
                logToConsole(args.join(' '));
            }
        };
    </script>

    <!-- Sistema Modular -->
    <script src="js/modal-components/base-component.js"></script>
    <script src="js/modal-components/discharge-component.js"></script>
    <script src="js/modal-components/notes-component.js"></script>
    <script src="js/modal-orchestrator.js"></script>
</body>
</html>
