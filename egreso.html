<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egreso de Paciente - IntraNeuro</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/egreso.css?v=2">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header - Igual que index.html -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/img/logo.png" alt="INTRANEURO" class="header-logo">
                <span class="clinic-name">INTRANEURO</span>
            </div>
            <div class="user-section">
                <span id="currentUser">Sistema de Egreso</span>
                <button id="logoutBtn" class="btn-logout" onclick="window.location.href='index.html'">
                    ‚Üê Volver al Dashboard
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <div class="egreso-container">
            <!-- Header -->
            <div class="egreso-header">
                <h1>üè• Egreso de Paciente</h1>
                <div id="patient-header-info" class="patient-info">
                    Cargando informaci√≥n del paciente...
                </div>
            </div>

            <!-- Body -->
            <div class="egreso-body">
                <!-- Loading State -->
                <div id="loading-state" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Cargando datos del paciente...</p>
                </div>

                <!-- Error State -->
                <div id="error-state" class="error-state" style="display: none;">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h2>Error al cargar paciente</h2>
                    <p id="error-message">No se pudo cargar la informaci√≥n del paciente.</p>
                    <a href="index.html" class="back-link">
                        ‚Üê Volver al Dashboard
                    </a>
                </div>

                <!-- Discharge Component Container -->
                <div id="discharge-container" style="display: none;">
                    <!-- DischargeComponent se renderiza aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <!-- API para DischargeComponent -->
    <script>
        // PacientesAPI global (simplificado para esta p√°gina)
        const PacientesAPI = {
            async toggleScheduledDischargeAPI(patientId, value) {
                try {
                    const response = await apiRequest(`/patients/${patientId}/scheduled-discharge`, {
                        method: 'PUT',
                        body: JSON.stringify({ scheduledDischarge: value })
                    });
                    return response;
                } catch (error) {
                    console.error('[PacientesAPI] Error toggle alta programada:', error);
                    throw error;
                }
            },

            async processDischargeAPI(patientId, dischargeData) {
                try {
                    const response = await apiRequest(`/patients/${patientId}/discharge`, {
                        method: 'PUT',
                        body: JSON.stringify(dischargeData)
                    });
                    return response;
                } catch (error) {
                    console.error('[PacientesAPI] Error procesando egreso:', error);
                    throw error;
                }
            }
        };

        // Toast global
        window.showToast = function(message, type = 'success') {
            alert(`[${type.toUpperCase()}] ${message}`);
        };
    </script>

    <!-- Componentes Modulares -->
    <script src="js/modal-components/base-component.js?v=1"></script>
    <script src="js/modal-components/discharge-component.js?v=2"></script>

    <!-- App Logic -->
    <script>
        // Estado global
        let currentPatient = null;
        let dischargeComponent = null;

        /**
         * Obtener patientId de la URL
         */
        function getPatientIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('patientId');
        }

        /**
         * Cargar datos del paciente desde el backend
         */
        async function loadPatient(patientId) {
            try {
                console.log(`[Egreso] Cargando paciente ${patientId}...`);

                const response = await apiRequest(`/patients/${patientId}`);

                if (!response || !response.id) {
                    throw new Error('Paciente no encontrado');
                }

                currentPatient = response;
                console.log('[Egreso] Paciente cargado:', currentPatient);

                return currentPatient;

            } catch (error) {
                console.error('[Egreso] Error cargando paciente:', error);
                throw error;
            }
        }

        /**
         * Renderizar DischargeComponent
         */
        function renderDischargeComponent() {
            // Ocultar loading
            document.getElementById('loading-state').style.display = 'none';

            // Mostrar container
            const container = document.getElementById('discharge-container');
            container.style.display = 'block';

            // Actualizar header con campos editables
            const headerInfo = document.getElementById('patient-header-info');
            headerInfo.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <strong style="font-weight: 600; color: #555;">Nombre:</strong>
                        <span id="name-${currentPatient.id}"
                              onclick="editPatientFieldInline(event, ${currentPatient.id}, 'name', '${currentPatient.name.replace(/'/g, "\\'")}')"
                              style="cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;"
                              onmouseover="this.style.background='#f0f0f0'"
                              onmouseout="this.style.background='transparent'"
                              title="Clic para editar">
                            ${currentPatient.name}
                        </span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <strong style="font-weight: 600; color: #555;">Cama:</strong>
                        <span id="bed-${currentPatient.id}"
                              onclick="editPatientFieldInline(event, ${currentPatient.id}, 'bed', '${currentPatient.bed || ''}')"
                              style="cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;"
                              onmouseover="this.style.background='#f0f0f0'"
                              onmouseout="this.style.background='transparent'"
                              title="Clic para editar">
                            ${currentPatient.bed || 'N/A'}
                        </span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <strong style="font-weight: 600; color: #555;">RUT:</strong>
                        <span id="rut-${currentPatient.id}"
                              onclick="editPatientFieldInline(event, ${currentPatient.id}, 'rut', '${currentPatient.rut || ''}')"
                              style="cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;"
                              onmouseover="this.style.background='#f0f0f0'"
                              onmouseout="this.style.background='transparent'"
                              title="Clic para editar">
                            ${currentPatient.rut || 'N/A'}
                        </span>
                    </div>
                </div>
            `;

            // Crear instancia del componente
            dischargeComponent = new DischargeComponent('discharge-container', currentPatient);

            // Renderizar
            dischargeComponent.mount();
        }

        /**
         * Editar campo inline (nombre, cama, RUT)
         */
        async function editPatientFieldInline(event, patientId, fieldName, currentValue) {
            event.stopPropagation();

            const fieldLabels = {
                name: 'Nombre',
                bed: 'Cama',
                rut: 'RUT'
            };

            const newValue = prompt(`Editar ${fieldLabels[fieldName]}:`, currentValue);

            if (newValue === null || newValue === currentValue) {
                return; // Cancelado o sin cambios
            }

            try {
                // Actualizar en el backend
                const response = await apiRequest(`/patients/${patientId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ [fieldName]: newValue.trim() })
                });

                if (response) {
                    // Actualizar en el objeto local
                    currentPatient[fieldName] = newValue.trim();

                    // Actualizar en la UI
                    const element = document.getElementById(`${fieldName}-${patientId}`);
                    if (element) {
                        element.textContent = newValue.trim() || 'N/A';
                    }

                    showToast(`${fieldLabels[fieldName]} actualizado correctamente`);
                }
            } catch (error) {
                console.error(`Error actualizando ${fieldName}:`, error);
                alert(`Error al actualizar ${fieldLabels[fieldName]}`);
            }
        }

        /**
         * Mostrar error
         */
        function showError(message) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        /**
         * Inicializaci√≥n
         */
        async function init() {
            // Verificar autenticaci√≥n
            if (!localStorage.getItem('token')) {
                window.location.href = 'login.html';
                return;
            }

            // Obtener patientId de URL
            const patientId = getPatientIdFromURL();

            if (!patientId) {
                showError('ID de paciente no especificado en la URL.');
                return;
            }

            try {
                // Cargar paciente
                await loadPatient(patientId);

                // Renderizar componente
                renderDischargeComponent();

            } catch (error) {
                showError(error.message || 'Error al cargar el paciente.');
            }
        }

        // Event listener: paciente egresado
        document.addEventListener('patient:discharged', (event) => {
            console.log('[Egreso] Paciente egresado:', event.detail);

            // Redirect a dashboard con par√°metro para forzar recarga
            // El toast ya se mostr√≥ en el componente, no necesitamos alert duplicado
            setTimeout(() => {
                window.location.href = 'index.html?reload=' + Date.now();
            }, 1500); // Dar tiempo a que el usuario vea el toast antes del redirect
        });

        // Iniciar al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
