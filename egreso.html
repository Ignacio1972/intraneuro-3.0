<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egreso de Paciente - IntraNeuro</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/egreso.css?v=3">
    <link rel="stylesheet" href="css/dropdown-system.css?v=1">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header - Igual que index.html -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/img/logo.png" alt="INTRANEURO" class="header-logo">
                <span class="clinic-name">INTRANEURO</span>
            </div>
            <div class="user-section">
                <span id="currentUser">Sistema de Egreso</span>
                <button id="logoutBtn" class="btn-logout" onclick="window.location.href='index.html'">
                    ← Volver al Dashboard
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <div class="egreso-container">
            <!-- Header -->
            <div class="egreso-header">
                <h1>Egreso de Paciente</h1>
                <div id="patient-name-display" class="patient-name">
                    Cargando...
                </div>
                <div id="patient-header-info" class="patient-info-grid">
                    <!-- Se renderiza dinámicamente -->
                </div>
            </div>

            <!-- Body -->
            <div class="egreso-body">
                <!-- Loading State -->
                <div id="loading-state" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Cargando datos del paciente...</p>
                </div>

                <!-- Error State -->
                <div id="error-state" class="error-state" style="display: none;">
                    <div class="error-icon">⚠️</div>
                    <h2>Error al cargar paciente</h2>
                    <p id="error-message">No se pudo cargar la información del paciente.</p>
                    <a href="index.html" class="back-link">
                        ← Volver al Dashboard
                    </a>
                </div>

                <!-- Discharge Component Container -->
                <div id="discharge-container" style="display: none;">
                    <!-- DischargeComponent se renderiza aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/modules/dropdown-system.js?v=3.1"></script>

    <!-- API para DischargeComponent -->
    <script>
        // PacientesAPI global (simplificado para esta página)
        const PacientesAPI = {
            async toggleScheduledDischargeAPI(patientId, value) {
                try {
                    const response = await apiRequest(`/patients/${patientId}/scheduled-discharge`, {
                        method: 'PUT',
                        body: JSON.stringify({ scheduledDischarge: value })
                    });
                    return response;
                } catch (error) {
                    console.error('[PacientesAPI] Error toggle alta programada:', error);
                    throw error;
                }
            },

            async processDischargeAPI(patientId, dischargeData) {
                try {
                    const response = await apiRequest(`/patients/${patientId}/discharge`, {
                        method: 'PUT',
                        body: JSON.stringify(dischargeData)
                    });
                    return response;
                } catch (error) {
                    console.error('[PacientesAPI] Error procesando egreso:', error);
                    throw error;
                }
            }
        };

        // Toast global
        window.showToast = function(message, type = 'success') {
            alert(`[${type.toUpperCase()}] ${message}`);
        };
    </script>

    <!-- Componentes Modulares -->
    <script src="js/modal-components/base-component.js?v=1"></script>
    <script src="js/modal-components/discharge-component.js?v=2"></script>

    <!-- App Logic -->
    <script>
        // Estado global
        let currentPatient = null;
        let dischargeComponent = null;

        /**
         * Obtener patientId de la URL
         */
        function getPatientIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('patientId');
        }

        /**
         * Cargar datos del paciente desde el backend
         */
        async function loadPatient(patientId) {
            try {
                console.log(`[Egreso] Cargando paciente ${patientId}...`);

                const response = await apiRequest(`/patients/${patientId}`);

                if (!response || !response.id) {
                    throw new Error('Paciente no encontrado');
                }

                currentPatient = response;
                console.log('[Egreso] Paciente cargado:', currentPatient);

                return currentPatient;

            } catch (error) {
                console.error('[Egreso] Error cargando paciente:', error);
                throw error;
            }
        }

        /**
         * Renderizar DischargeComponent
         */
        function renderDischargeComponent() {
            // Ocultar loading
            document.getElementById('loading-state').style.display = 'none';

            // Mostrar container
            const container = document.getElementById('discharge-container');
            container.style.display = 'block';

            // Actualizar nombre del paciente (grande, destacado)
            const nameDisplay = document.getElementById('patient-name-display');
            nameDisplay.textContent = currentPatient.name;
            nameDisplay.onclick = () => editPatientFieldInline(event, currentPatient.id, 'name', currentPatient.name);
            nameDisplay.title = 'Clic para editar nombre';
            nameDisplay.id = `name-${currentPatient.id}`;

            // Actualizar grid de información (dos columnas)
            const headerInfo = document.getElementById('patient-header-info');
            headerInfo.innerHTML = `
                <div class="info-item">
                    <span class="label">Cama:</span>
                    <span class="value" id="bed-${currentPatient.id}"
                          onclick="editPatientFieldInline(event, ${currentPatient.id}, 'bed', '${currentPatient.bed || ''}')"
                          title="Clic para editar">
                        ${currentPatient.bed || 'N/A'}
                    </span>
                </div>
                <div class="info-item">
                    <span class="label">RUT:</span>
                    <span class="value" id="rut-${currentPatient.id}"
                          onclick="editPatientFieldInline(event, ${currentPatient.id}, 'rut', '${currentPatient.rut || ''}')"
                          title="Clic para editar">
                        ${currentPatient.rut || 'N/A'}
                    </span>
                </div>
                <div class="info-item">
                    <span class="label">Previsión:</span>
                    <span class="value" id="prevision-${currentPatient.id}"
                          onclick="editPatientPrevision(event, ${currentPatient.id})"
                          title="Clic para editar">
                        ${currentPatient.prevision || 'N/A'}
                    </span>
                </div>
                <div class="info-item">
                    <span class="label">Diagnóstico:</span>
                    <span class="value" id="diagnosis-${currentPatient.id}"
                          onclick="editPatientDiagnosis(event, ${currentPatient.id})"
                          title="Clic para editar">
                        ${currentPatient.diagnosis || 'N/A'}
                    </span>
                </div>
            `;

            // Crear instancia del componente
            dischargeComponent = new DischargeComponent('discharge-container', currentPatient);

            // Renderizar
            dischargeComponent.mount();
        }

        /**
         * Editar campo inline (nombre, cama, RUT)
         */
        async function editPatientFieldInline(event, patientId, fieldName, currentValue) {
            event.stopPropagation();

            const fieldLabels = {
                name: 'Nombre',
                bed: 'Cama',
                rut: 'RUT',
                prevision: 'Previsión'
            };

            const newValue = prompt(`Editar ${fieldLabels[fieldName]}:`, currentValue);

            if (newValue === null || newValue === currentValue) {
                return; // Cancelado o sin cambios
            }

            try {
                // Actualizar en el backend
                const response = await apiRequest(`/patients/${patientId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ [fieldName]: newValue.trim() })
                });

                if (response) {
                    // Actualizar en el objeto local
                    currentPatient[fieldName] = newValue.trim();

                    // Actualizar en la UI
                    const element = document.getElementById(`${fieldName}-${patientId}`);
                    if (element) {
                        element.textContent = newValue.trim() || 'N/A';
                    }

                    showToast(`${fieldLabels[fieldName]} actualizado correctamente`);
                }
            } catch (error) {
                console.error(`Error actualizando ${fieldName}:`, error);
                alert(`Error al actualizar ${fieldLabels[fieldName]}`);
            }
        }

        /**
         * Editar diagnóstico con acordeón
         */
        function editPatientDiagnosis(event, patientId) {
            event.stopPropagation();

            const currentValue = currentPatient.diagnosis || '';

            DropdownSystem.showDiagnosisAccordion({
                currentValue: currentValue,
                onSelect: async function(value) {
                    if (!value || value === currentValue) {
                        return; // Sin cambios
                    }

                    try {
                        // Guardar en el backend
                        const response = await apiRequest(`/patients/${patientId}`, {
                            method: 'PUT',
                            body: JSON.stringify({ diagnosis: value })
                        });

                        if (response) {
                            // Actualizar objeto local
                            currentPatient.diagnosis = value;

                            // Actualizar UI
                            const element = document.getElementById(`diagnosis-${patientId}`);
                            if (element) {
                                element.textContent = value;
                            }

                            showToast('Diagnóstico actualizado correctamente');
                        }
                    } catch (error) {
                        console.error('Error actualizando diagnóstico:', error);
                        alert('Error al actualizar el diagnóstico');
                    }
                },
                onCancel: function() {
                    // No hacer nada
                }
            });
        }

        /**
         * Editar previsión con dropdown
         */
        function editPatientPrevision(event, patientId) {
            event.stopPropagation();

            const currentValue = currentPatient.prevision || '';

            DropdownSystem.showPrevisionSelector({
                currentValue: currentValue,
                onSelect: async function(value) {
                    if (!value || value === currentValue) {
                        return; // Sin cambios
                    }

                    try {
                        // Guardar en el backend
                        const response = await apiRequest(`/patients/${patientId}/prevision`, {
                            method: 'PUT',
                            body: JSON.stringify({ prevision: value })
                        });

                        if (response) {
                            // Actualizar objeto local
                            currentPatient.prevision = value;

                            // Actualizar UI
                            const element = document.getElementById(`prevision-${patientId}`);
                            if (element) {
                                element.textContent = value;
                            }

                            showToast('Previsión actualizada correctamente');
                        }
                    } catch (error) {
                        console.error('Error actualizando previsión:', error);
                        alert('Error al actualizar la previsión');
                    }
                },
                onCancel: function() {
                    // No hacer nada
                }
            });
        }

        /**
         * Mostrar error
         */
        function showError(message) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        /**
         * Inicialización
         */
        async function init() {
            // Verificar autenticación
            if (!localStorage.getItem('token')) {
                window.location.href = 'login.html';
                return;
            }

            // Obtener patientId de URL
            const patientId = getPatientIdFromURL();

            if (!patientId) {
                showError('ID de paciente no especificado en la URL.');
                return;
            }

            try {
                // Cargar paciente
                await loadPatient(patientId);

                // Renderizar componente
                renderDischargeComponent();

            } catch (error) {
                showError(error.message || 'Error al cargar el paciente.');
            }
        }

        // Event listener: paciente egresado
        document.addEventListener('patient:discharged', (event) => {
            console.log('[Egreso] Paciente egresado:', event.detail);

            // Redirect a dashboard con parámetro para forzar recarga
            // El toast ya se mostró en el componente, no necesitamos alert duplicado
            setTimeout(() => {
                window.location.href = 'index.html?reload=' + Date.now();
            }, 1500); // Dar tiempo a que el usuario vea el toast antes del redirect
        });

        // Iniciar al cargar la página
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
